name: build

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container: espressif/idf:v5.5.1

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build (ESP32-S3)
        shell: bash
        run: |
          . /opt/esp/entrypoint.sh
          idf.py set-target esp32s3
          idf.py build

      - name: Generate SHA256
        shell: bash
        run: |
          sha256sum build/wallter.bin > build/wallter.bin.sha256

      - name: Prepare OTA release binary
        shell: bash
        run: |
          set -euo pipefail
          cp build/wallter.bin build/wallter-ota.bin
          sha256sum build/wallter-ota.bin > build/wallter-ota.bin.sha256

      - name: Package flashable bundle
        shell: bash
        run: |
          set -euo pipefail
          BUNDLE_NAME="wallter-esp32s3-flashable"
          if [[ "${GITHUB_REF:-}" == refs/tags/* ]]; then
            BUNDLE_NAME+="-${GITHUB_REF_NAME}"
          fi
          BUNDLE_PATH="build/${BUNDLE_NAME}.zip"
          export BUNDLE_PATH

          python3 - <<'PY'
          import os
          import zipfile

          bundle_path = os.environ["BUNDLE_PATH"]
          files = [
              ("build/wallter.bin", "wallter.bin"),
              ("build/wallter.bin.sha256", "wallter.bin.sha256"),
              ("build/bootloader/bootloader.bin", "bootloader.bin"),
              ("build/partition_table/partition-table.bin", "partition-table.bin"),
              ("build/ota_data_initial.bin", "ota_data_initial.bin"),
              ("build/flasher_args.json", "flasher_args.json"),
              ("build/flash_args", "flash_args"),
              ("build/flash_project_args", "flash_project_args"),
          ]

          missing = [src for src, _ in files if not os.path.exists(src)]
          if missing:
              raise SystemExit(f"Missing expected build outputs: {missing}")

          os.makedirs(os.path.dirname(bundle_path), exist_ok=True)
          with zipfile.ZipFile(bundle_path, "w", compression=zipfile.ZIP_DEFLATED) as z:
              for src, dst in files:
                  z.write(src, dst)
          print(f"Wrote {bundle_path}")
          PY

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: wallter-esp32s3
          path: |
            build/wallter.bin
            build/wallter.bin.sha256
            build/wallter-ota.bin
            build/wallter-ota.bin.sha256
            build/wallter-esp32s3-flashable*.zip

      - name: Upload to GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            build/wallter-ota.bin
            build/wallter-ota.bin.sha256
            build/wallter.bin
            build/wallter.bin.sha256
            build/wallter-esp32s3-flashable-${{ github.ref_name }}.zip
